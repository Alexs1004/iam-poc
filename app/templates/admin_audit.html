{% extends "base.html" %}

{% block content %}
<section class="panel admin-dashboard">
  <div class="admin-hero">
    <div class="admin-hero-body">
      <h1>Audit Trail — JML Events</h1>
      <p class="intro">
        Cryptographically signed audit log tracking all lifecycle operations. Each event includes HMAC-SHA256 signature for tamper detection and integrity verification.
      </p>
      <div class="hero-actions">
        <a class="btn-console" href="{{ url_for('admin.admin_dashboard') }}">
          ← Back to Admin Dashboard
        </a>
        {% if keycloak_console_url %}
        <a class="btn-console" href="{{ keycloak_console_url }}" target="_blank" rel="noopener noreferrer">
          Open Keycloak Console
        </a>
        {% endif %}
      </div>
    </div>
    <div class="admin-hero-meta">
      <span class="hero-label">Total Events</span>
      <span class="hero-value">{{ total_events }}</span>
      <span class="hero-subtext">{{ integrity_status }}</span>
    </div>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <span class="stat-label">Total Events</span>
      <span class="stat-value">{{ total_events }}</span>
      <span class="stat-hint">Recorded JML operations</span>
    </div>
    <div class="stat-card">
      <span class="stat-label">Valid Signatures</span>
      <span class="stat-value">{{ valid_signatures }}</span>
      <span class="stat-hint">HMAC-SHA256 verified</span>
    </div>
    <div class="stat-card">
      <span class="stat-label">Integrity Status</span>
      <span class="stat-value {% if total_events != valid_signatures %}stat-warning{% else %}stat-success{% endif %}">
        {{ integrity_status }}
      </span>
      <span class="stat-hint">
        {% if total_events == valid_signatures %}
          ✓ No tampering detected
        {% else %}
          ⚠ Verification issues found
        {% endif %}
      </span>
    </div>
  </div>

  <div class="card">
    <div class="card-heading">
      <h2>Audit Log ({{ events|length }})</h2>
      <p class="card-subtitle">Chronological record of all JML operations with cryptographic signatures.</p>
    </div>
    <div class="card-body">
      {% if events %}
        <div class="admin-table-wrapper">
          <table class="user-table audit-table">
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>Event Type</th>
                <th>Username</th>
                <th>Operator</th>
                <th>Status</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody>
              {% for event in events %}
              <tr class="{% if not event.success %}audit-row-error{% endif %}">
                <td>
                  <div class="audit-timestamp">
                    <span class="timestamp-date">{{ event.timestamp[:10] }}</span>
                    <span class="timestamp-time">{{ event.timestamp[11:19] }}</span>
                  </div>
                </td>
                <td>
                  <span class="event-badge event-{{ event.event_type }}">
                    {{ event.event_type }}
                  </span>
                </td>
                <td>
                  <code class="audit-username">{{ event.username }}</code>
                </td>
                <td>
                  <span class="audit-operator">{{ event.operator }}</span>
                </td>
                <td>
                  {% if event.success %}
                    <span class="label-pill success">✓ Success</span>
                  {% else %}
                    <span class="label-pill warning">✗ Failed</span>
                  {% endif %}
                </td>
                <td>
                  <details class="audit-details">
                    <summary>View details</summary>
                    <pre class="audit-json">{{ event.details | tojson(indent=2) }}</pre>
                  </details>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="empty-state">
          <h3>No audit events yet</h3>
          <p>JML operations (Joiner/Mover/Leaver) will be automatically logged here with cryptographic signatures.</p>
        </div>
      {% endif %}
    </div>
  </div>
</section>
{% endblock %}
