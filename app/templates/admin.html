{% extends "base.html" %}
{% block content %}
<section class="panel admin-dashboard">
  <h1>Joiner / Mover / Leaver control center</h1>
  <p class="intro">
    Orchestrate account lifecycle automation directly against Keycloak. Use the forms to provision, update, or disable demo users; the table reflects the latest state pulled from the realm.
  </p>

  <div class="layout-grid admin-grid">
    <div class="card">
      <h2>Automation forms</h2>

      <section class="form-section">
        <h3>Provision user (Joiner)</h3>
        <form method="post" action="{{ url_for('admin_joiner') }}" class="form-grid">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <div class="form-field">
            <label for="joiner-first">First name</label>
            <input id="joiner-first" name="first_name" type="text" required placeholder="Alice">
          </div>
          <div class="form-field">
            <label for="joiner-last">Last name</label>
            <input id="joiner-last" name="last_name" type="text" required placeholder="Demo">
          </div>
          <div class="form-field">
            <label for="joiner-email">Email</label>
            <input id="joiner-email" name="email" type="email" required placeholder="alice@example.com">
          </div>
          <div class="form-field">
            <label for="joiner-username">Username</label>
            <input id="joiner-username" name="username" type="text" required placeholder="alice">
          </div>
          <div class="form-field">
            <label for="joiner-role">Role</label>
            <select id="joiner-role" name="role" required>
              {% for role in assignable_roles %}
                <option value="{{ role }}">{{ role }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-field">
            <label for="joiner-temp">Temporary password <span class="muted">(optional)</span></label>
            <input id="joiner-temp" name="temp_password" type="text" placeholder="Auto-generate if blank">
          </div>
          <div class="form-field checkbox-field">
            <input id="joiner-totp" name="require_totp" type="checkbox" checked>
            <label for="joiner-totp">Require TOTP enrollment at first login</label>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Provision user</button>
          </div>
        </form>
      </section>

      <section class="form-section">
        <h3>Update role (Mover)</h3>
        {% if existing_users %}
          <form method="post" action="{{ url_for('admin_mover') }}" class="form-grid">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <div class="form-field">
              <label for="mover-username">User</label>
              <select id="mover-username" name="username" required>
                {% for user in existing_users %}
                  <option value="{{ user.username }}">{{ user.display_name }} ({{ user.username }})</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-field">
              <label for="mover-source">Current role</label>
              <select id="mover-source" name="source_role" required>
                {% for role in assignable_roles %}
                  <option value="{{ role }}">{{ role }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-field">
              <label for="mover-target">New role</label>
              <select id="mover-target" name="target_role" required>
                {% for role in assignable_roles %}
                  <option value="{{ role }}">{{ role }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn btn-secondary">Update role</button>
            </div>
          </form>
        {% else %}
          <p class="muted">No managed users are available yet. Provision a user before updating roles.</p>
        {% endif %}
      </section>

      <section class="form-section">
        <h3>Disable account (Leaver)</h3>
        {% if existing_users %}
          <form method="post" action="{{ url_for('admin_leaver') }}" class="form-grid">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <div class="form-field">
              <label for="leaver-username">User</label>
              <select id="leaver-username" name="username" required>
                {% for user in existing_users %}
                  <option value="{{ user.username }}">{{ user.display_name }} ({{ user.username }})</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn btn-danger">Disable user</button>
            </div>
          </form>
        {% else %}
          <p class="muted">Provision an account before simulating a leaver.</p>
        {% endif %}
      </section>

      {% if keycloak_console_url %}
        <div class="console-cta">
          <a class="btn-console" href="{{ keycloak_console_url }}" target="_blank" rel="noopener noreferrer">
            Open Keycloak Console
            <span aria-hidden="true">↗</span>
          </a>
        </div>
      {% endif %}
    </div>

    <div class="card">
      <h2>Realm user snapshot ({{ user_statuses|length }})</h2>
      <table class="user-table">
        <thead>
          <tr>
            <th>User</th>
            <th>Status</th>
            <th>Roles</th>
            <th>Required actions</th>
            <th>MFA</th>
          </tr>
        </thead>
        <tbody>
          {% for user in user_statuses %}
            <tr>
              <td>
                <div class="user-meta">
                  <span class="user-name">{{ user.display_name or user.username }}</span>
                  <span class="user-username">@{{ user.username }}</span>
                  {% if user.email %}
                    <span class="user-email">{{ user.email }}</span>
                  {% endif %}
                </div>
              </td>
              <td>
                {% if user.exists %}
                  <span class="status-chip {{ 'active' if user.enabled else 'disabled' }}">
                    {{ 'Active' if user.enabled else 'Disabled' }}
                  </span>
                {% else %}
                  <span class="status-chip missing">Missing</span>
                {% endif %}
              </td>
              <td class="role-cell">
                {% if user.roles %}
                  {% for role in user.roles %}
                    <span class="role-chip{% if role == 'admin' %} admin{% endif %}">{{ role }}</span>
                  {% endfor %}
                {% else %}
                  <span class="muted">—</span>
                {% endif %}
              </td>
              <td>
                {% if user.required_actions %}
                  {% for action in user.required_actions %}
                    <span class="label-pill warning">{{ action }}</span>
                  {% endfor %}
                {% else %}
                  <span class="label-pill success">Clear</span>
                {% endif %}
              </td>
              <td>
                <span class="label-pill {{ 'success' if user.totp_enrolled else 'warning' }}">
                  {{ 'Enrolled' if user.totp_enrolled else 'Pending' }}
                </span>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>
{% endblock %}
