{% extends "base.html" %}
{% block content %}
<section class="panel verification-panel">
  <!-- Header with mode indicator -->
  <div class="verification-header">
    <div class="header-content">
  <h1>SCIM 2.0 API Verification Suite</h1>
      <p class="header-description">
        Automated security and compliance testing for enterprise IAM provisioning.
        <strong>Ensures zero-trust access control and audit-ready logging for SOC 2 / ISO 27001 compliance.</strong>
      </p>
      <div class="compliance-badges">
        <span class="badge-cert">âœ“ RFC 7644 Compliant</span>
        <span class="badge-cert">âœ“ OAuth 2.0 + PKCE</span>
        <span class="badge-cert">âœ“ HMAC-SHA256 Audit</span>
        <span class="badge-cert">âœ“ 90%+ Test Coverage</span>
      </div>
      
      <!-- Environment badge with clear context -->
      <div class="env-badge-container">
        {% if demo_mode %}
        <div class="env-badge env-demo" title="Running against local Keycloak with test credentials for demonstration purposes">
          <span class="env-icon">ðŸ§ª</span>
          <div class="env-content">
            <span class="env-label">Demo Environment</span>
            <span class="env-sublabel">Local Keycloak Â· Test Data</span>
          </div>
        </div>
        {% else %}
        <div class="env-badge env-production" title="Production-ready configuration with Azure AD and Key Vault">
          <span class="env-icon">ðŸ”’</span>
          <div class="env-content">
            <span class="env-label">Production Setup</span>
            <span class="env-sublabel">Azure AD Â· Key Vault</span>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Introduction card for recruiters -->
  <div class="card intro-card">
    <div class="card-heading">
      <h2>What is this?</h2>
      <p class="card-subtitle">This page demonstrates <strong>automated security testing</strong> for a SCIM 2.0 API implementation. It validates RFC 7644 compliance, OAuth 2.0 security controls, and audit trail integrity.</p>
    </div>
    <div class="card-body">
    <div class="features-grid">
      <div class="feature-item">
        <div class="feature-icon" aria-hidden="true">
          <!-- lock icon -->
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M12 1C9.79 1 8 2.79 8 5v3H6a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2h-2V5c0-2.21-1.79-4-4-4z" fill="currentColor" opacity="0.9"/>
          </svg>
        </div>
        <div class="feature-content">
          <strong>Authentication guards</strong>
          <p>OAuth Bearer token and scope validation to prevent unauthorized access.</p>
        </div>
      </div>
      <div class="feature-item">
        <div class="feature-icon" aria-hidden="true">
          <!-- crud icon -->
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zM13 21h8V11h-8v10zm0-18v6h8V3h-8z" fill="currentColor" opacity="0.9"/>
          </svg>
        </div>
        <div class="feature-content">
          <strong>CRUD operations</strong>
          <p>Verifies SCIM create/read/update/delete flows and correct status codes.</p>
        </div>
      </div>
      <div class="feature-item">
        <div class="feature-icon" aria-hidden="true">
          <!-- shield icon -->
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 1l8 4v6c0 5.25-3.83 10.74-8 12-4.17-1.26-8-6.75-8-12V5l8-4z" fill="currentColor" opacity="0.9"/>
          </svg>
        </div>
        <div class="feature-content">
          <strong>Security validations</strong>
          <p>Content-Type enforcement, filter validation, and unsupported operation handling.</p>
        </div>
      </div>
      <div class="feature-item">
        <div class="feature-icon" aria-hidden="true">
          <!-- audit icon -->
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 3h18v2H3V3zm2 6h14v12H5V9zm3 2v8h2v-8H8zm4 0v8h6v-8h-6z" fill="currentColor" opacity="0.9"/>
          </svg>
        </div>
        <div class="feature-content">
          <strong>Audit integrity</strong>
          <p>HMAC-SHA256 signing protects audit entries from tampering.</p>
        </div>
      </div>
    </div>
    </div>
  </div>

  <!-- Quick KPI summary card -->
  {% if executed_at %}
  <div class="card kpi-summary-card">
    <div class="kpi-grid">
      <div class="kpi-item">
        <div class="kpi-label">Last Run</div>
        <div class="kpi-value">{{ executed_at }}</div>
      </div>
      <div class="kpi-item">
        <div class="kpi-label">Status</div>
        <div class="kpi-value">
          {% if overall_status == 'success' %}
            <span class="label-pill success">All Passed</span>
          {% elif overall_status == 'partial' %}
            <span class="label-pill warning">Partial</span>
          {% else %}
            <span class="label-pill warning">Failed</span>
          {% endif %}
        </div>
      </div>
      <div class="kpi-item">
        <div class="kpi-label">Total Checks</div>
        <div class="kpi-value kpi-number">{{ results|length if results else 'â€”' }}</div>
      </div>
      <div class="kpi-item">
        <div class="kpi-label">Pass Rate</div>
        <div class="kpi-value kpi-number">
          {% if results %}
            {{ ((results | selectattr('status', 'equalto', 'success') | list | length) / (results|length) * 100) | round(1) }}%
          {% else %}
            â€”
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  
  {% if demo_mode %}
  <div class="demo-context">
    <span class="label-pill muted">Demo Environment</span>
    <span class="context-note">Tests run against local Keycloak instance with synthetic data. Production setup uses Azure AD + Key Vault for secrets management.</span>
  </div>
  {% endif %}
  {% endif %}

  <!-- Actions card -->
  <div class="card actions-card">
    <div class="card-heading">
      <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:1rem;">
        <div>
          <h2>Run Verification</h2>
          <p class="card-subtitle">Execute the full test suite or cleanup test data</p>
        </div>
        <div class="card-actions">
          <div class="verification-actions">
            <form method="post" class="verification-form">
              <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
              <input type="hidden" name="action" value="run">
              <button type="submit" class="btn btn-primary">
                Run full verification
              </button>
            </form>
            <form method="post" class="verification-form">
              <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
              <input type="hidden" name="action" value="cleanup">
              <button type="submit" class="btn btn-secondary">
                Cleanup test users
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div class="card-body">
    
    {% if cleanup_count > 0 %}
      <div class="cleanup-summary">
        <strong>Cleanup completed:</strong>
        <span class="label-pill success">{{ cleanup_count }} removed</span>
        <span class="card-subtitle" style="margin-left:8px;">(userName: verifier-*)</span>
      </div>
    {% endif %}
  </div>

  {% if results %}
    <div class="card results-card">
      <div class="card-heading">
        <h2>Detailed Test Results</h2>
        <p class="card-subtitle">Each check validates a specific security control or RFC 7644 requirement</p>
      </div>
      <div class="card-body">
      
      <div class="table-wrapper">
        <table class="verification-table">
          <thead>
            <tr>
              <th class="col-check">Test Case</th>
              <th class="col-status">Status</th>
              <th class="col-http">HTTP</th>
              <th class="col-detail">Details / Expected Behavior</th>
              <th class="col-correlation">Correlation ID</th>
              <th class="col-duration">Duration</th>
            </tr>
          </thead>
          <tbody>
            {% for item in results %}
              <tr class="row-{{ item.status }}">
                <td class="check-name">{{ item.name }}</td>
                <td class="status-cell">
                  {% if item.status == 'success' %}
                    <span class="label-pill success">PASS</span>
                  {% elif item.status == 'failure' %}
                    <span class="label-pill warning">FAIL</span>
                  {% else %}
                    <span class="label-pill muted">SKIP</span>
                  {% endif %}
                </td>
                <td class="http-code">
                  {% if item.status_code %}
                    <span class="code-badge code-{{ item.status_code }}">{{ item.status_code }}</span>
                  {% else %}
                    <span class="code-badge code-none">â€”</span>
                  {% endif %}
                </td>
                <td class="detail-cell">{{ item.detail }}</td>
                <td class="correlation-cell">
                  {% if item.correlation_id %}
                    <code class="correlation-id">{{ item.correlation_id[:8] }}...</code>
                  {% else %}
                    <span class="no-value">â€”</span>
                  {% endif %}
                </td>
                <td class="duration-cell">
                  {% if item.duration_ms %}
                    <span class="duration-value">{{ item.duration_ms }}ms</span>
                  {% else %}
                    <span class="no-value">â€”</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      
      <!-- Interpretation guide -->
      <div class="interpretation-guide">
        <h3>Key takeaways for recruiters</h3>
        <ul class="takeaway-list">
          <li><strong>Authorization guards</strong> ensure only valid OAuth tokens with correct scopes can access data</li>
          <li><strong>Content-Type validation (415)</strong> prevents malformed requests and enforces RFC 7644 compliance</li>
          <li><strong>Unsupported operations (501)</strong> like PUT are not implemented in this PoC (PATCH is preferred for partial updates)</li>
          <li><strong>Audit signatures</strong> guarantee tamper-proof logging of all identity changes (HMAC-SHA256)</li>
          <li><strong>Filter validation</strong> prevents injection attacks and documents supported query patterns</li>
        </ul>
      </div>
      
      <!-- Call to action -->
      <div class="cta-card">
        <h3>Explore the Implementation</h3>
        <p>Review the SCIM 2.0 API documentation (OpenAPI/ReDoc), security architecture, and full source code on GitHub.</p>
        <div class="cta-actions">
          <a href="{{ url_for('docs.scim_docs') }}" class="btn btn-primary">API Documentation</a>
          <a href="https://github.com/Alexs1004/iam-poc" target="_blank" class="btn btn-secondary">View Source Code</a>
        </div>
      </div>
      </div>
    </div>
  {% endif %}
  
  {% if not rate_limiting_available %}
    <!-- Production readiness -->
    <div class="card security-note">
      <div class="card-heading">
        <h3>Production Readiness</h3>
      </div>
      <div class="card-body">
        <p>This PoC includes enterprise-grade security controls ready for production deployment.</p>
        
        <div class="prod-checklist">
          <div class="checklist-section">
            <h4>âœ… Implemented</h4>
            <ul>
              <li>OAuth 2.0 Bearer token authentication with scope validation</li>
              <li>Role-Based Access Control (RBAC) for scim:read / scim:write</li>
              <li>HMAC-SHA256 tamper-proof audit logs with correlation IDs</li>
              <li>Content-Type enforcement and input validation (RFC 7644)</li>
              <li>Automated test suite (90%+ coverage, 15+ security checks)</li>
            </ul>
          </div>
          
          <div class="checklist-section">
            <h4>ðŸ”§ Production Enhancements</h4>
            <ul>
              <li><strong>Rate limiting:</strong> nginx <code>limit_req</code> zone (5 req/s burst)</li>
              <li><strong>WAF:</strong> Azure Front Door or Cloudflare for DDoS protection</li>
              <li><strong>Certificate pinning:</strong> mTLS for inter-service communication</li>
              <li><strong>Secrets rotation:</strong> Automated Azure Key Vault integration</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  {% endif %}
  
  <!-- Technical stack card -->
  <div class="card tech-stack">
    <h3>Technical stack</h3>
    <div class="tech-grid">
      <div class="tech-item">
        <strong>IAM Provider:</strong> Keycloak (OIDC + PKCE)
      </div>
      <div class="tech-item">
        <strong>API Framework:</strong> Flask + Gunicorn (WSGI)
      </div>
      <div class="tech-item">
        <strong>Standards:</strong> SCIM 2.0 (RFC 7644), OAuth 2.0
      </div>
      <div class="tech-item">
        <strong>Security:</strong> RBAC, HMAC-SHA256 audit, nginx reverse proxy
      </div>
      <div class="tech-item">
        <strong>Testing:</strong> Pytest ({{ results|length if results else 'multiple' }} automated checks, 90%+ coverage)
      </div>
      <div class="tech-item">
        <strong>Deployment:</strong> Docker Compose, Azure Key Vault integration
      </div>
    </div>
  </div>
</section>

<script src="{{ url_for('static', filename='js/verification.js') }}"></script>
{% endblock %}
