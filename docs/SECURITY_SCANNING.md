# ğŸ” Security Scanning Guide

This project includes comprehensive security scanning tools integrated in both **local development** (via Makefile) and **CI/CD** (GitHub Actions).

## ğŸ“‹ Available Tools

| Tool | Purpose | Standards |
|------|---------|-----------|
| **Gitleaks** | Secret detection | Prevent API keys, tokens leaks |
| **Trivy** | CVE scanning | NIST SP 800-190 |
| **Syft** | SBOM generation | Executive Order 14028 |
| **Grype** | Vulnerability analysis | OWASP ASVS v4.0.3 |

---

## ğŸ–¥ï¸ Local Scanning (Makefile)

### Quick Start

```bash
# Run all security scans
make security-check

# Run individual scans
make scan-secrets      # Detect secrets (Gitleaks)
make scan-vulns        # Check CVEs (Trivy)
make sbom              # Generate SBOM (Syft)
make scan-sbom         # Scan SBOM vulnerabilities (Grype)
```

### Detailed Commands

#### **Scan for Secrets** (Gitleaks)
```bash
make scan-secrets
```
- **Detects**: API keys, tokens, passwords, private keys
- **Configuration**: `.gitleaks.toml`
- **Allowlist**: Demo files (`.env.demo`), test fixtures, `venv/`
- **Exit code**: `0` if no leaks, `1` if found

**Example output:**
```
[scan-secrets] Scanning for secrets with Gitleaks...
8:28AM INF scanned ~4.36 MB in 192ms
8:28AM INF no leaks found
[scan-secrets] âœ… No secrets found
```

---

#### **Scan for Vulnerabilities** (Trivy)
```bash
make scan-vulns          # Requirements.txt only (fast)
make scan-vulns-all      # Entire project (slower)
```
- **Detects**: CVE in Python packages
- **Severity**: HIGH, CRITICAL (blocks build)
- **Database**: Updated daily from NVD + GitHub Advisory
- **Exit code**: `0` if clean, `1` if HIGH/CRITICAL found

**Example output:**
```
[scan-vulns]  Scanning for vulnerabilities with Trivy...
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Target      â”‚ Type â”‚ Vulnerabilities â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ requirements.txt â”‚ pip  â”‚        0        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
[scan-vulns] âœ… No HIGH/CRITICAL vulnerabilities found
```

---

#### **Generate SBOM** (Syft)
```bash
make sbom
```
- **Formats**: SPDX-JSON + CycloneDX-JSON
- **Output**: `.runtime/sbom/`
- **Compliance**: Executive Order 14028 (SBOM requirement)
- **Size**: ~400KB (SPDX), ~245KB (CycloneDX)

**Example output:**
```
[sbom] Generating SBOM with Syft...
[sbom] âœ… SBOM generated:
    â€¢ .runtime/sbom/sbom-spdx.json (SPDX format)
    â€¢ .runtime/sbom/sbom-cyclonedx.json (CycloneDX format)
```

---

#### **Scan SBOM** (Grype)
```bash
make scan-sbom
```
- **Input**: SBOM generated by Syft
- **Detects**: Vulnerabilities in all dependencies
- **Fail on**: CRITICAL severity
- **Database**: NVD + OSV + GitHub Advisory

**Example output:**
```
[scan-sbom] Scanning SBOM with Grype...
NAME          INSTALLED  FIXED IN  TYPE    VULNERABILITY        SEVERITY
authlib       1.6.5      -         python  -                    -
cryptography  43.0.1     -         python  -                    -
[scan-sbom] âœ… No CRITICAL vulnerabilities in SBOM
```

---

## ğŸ¤– CI/CD Integration (GitHub Actions)

### Workflow: `.github/workflows/security-scans.yml`

**Triggers:**
- Push to `main`, `develop`, `feature/*`, `entra/*`
- Pull requests to `main`, `develop`
- Weekly schedule (Monday 00:00 UTC)

**Jobs:**

1. **trivy-scan** (Trivy CVE scanning)
   - Scans filesystem, `requirements.txt`, `Dockerfile.flask`
   - Uploads SARIF to GitHub Security tab
   - Fails on HIGH/CRITICAL vulnerabilities

2. **gitleaks-scan** (Secret detection)
   - Scans full Git history
   - Uploads report as artifact on failure

3. **sbom-generation** (Syft SBOM + Grype scan)
   - Generates SBOM (SPDX + CycloneDX)
   - Scans with Grype
   - Uploads SBOM as artifacts

4. **dependency-review** (GitHub native, PR only)
   - Compares dependencies vs base branch
   - Blocks on `moderate` or higher
   - Rejects GPL-2.0/GPL-3.0 licenses

5. **security-summary** (Aggregated results)
   - Displays all scan statuses
   - Adds summary to PR

---

## ğŸš¨ Handling Failures

### **Gitleaks finds secrets**

1. **Verify if false positive**:
   ```bash
   # Check detection
   docker run --rm -v $(pwd):/path ghcr.io/gitleaks/gitleaks:latest detect \
     --source /path --config /path/.gitleaks.toml --no-git --verbose
   ```

2. **Add to allowlist** (if legitimate demo/test data):
   ```toml
   # .gitleaks.toml
   [allowlist]
   paths = [
       '''tests/fixtures/demo-data\.json$''',  # Add your file
   ]
   ```

3. **Remove secret from Git history** (if real leak):
   ```bash
   git filter-repo --path-glob '*.env' --invert-paths
   # OR use BFG Repo-Cleaner
   ```

---

### **Trivy finds CVE**

1. **Update package**:
   ```bash
   # Example: Authlib 1.3.1 â†’ 1.6.5
   sed -i 's/Authlib==1.3.1/Authlib==1.6.5/' requirements.txt
   pip install -r requirements.txt
   ```

2. **Verify fix**:
   ```bash
   make scan-vulns
   ```

3. **If no patch available**, add temporary ignore:
   ```yaml
   # .trivyignore (not recommended)
   CVE-2024-XXXXX  # Waiting for upstream fix (ticket #1234)
   ```

---

### **Grype reports HIGH vulns in venv/**

**Solution**: Grype scans the SBOM, which should exclude `venv/`. If still detected:

```bash
# Regenerate SBOM without venv
rm -rf .runtime/sbom
make sbom
make scan-sbom
```

---

## Viewing Results

### **Local**
```bash
make security-check  # Run all scans with colored output
```

### **CI/CD (GitHub)**
1. Go to **Actions** tab â†’ Latest workflow run
2. Check individual job logs
3. View **Security** tab â†’ **Code scanning** for Trivy/Grype alerts
4. Download SBOM artifacts from workflow run

---

## ğŸ¯ Best Practices

### **Before Committing**
```bash
# Quick pre-commit check
make scan-secrets
make scan-vulns
```

### **Before PR Merge**
```bash
# Full security audit
make security-check
```

### **Weekly Maintenance**
```bash
# Update dependencies + scan
pip-compile requirements.in
pip install -r requirements.txt
make security-check
```

---

## ğŸ”— References

- [Gitleaks Documentation](https://github.com/gitleaks/gitleaks)
- [Trivy Documentation](https://aquasecurity.github.io/trivy/)
- [Syft Documentation](https://github.com/anchore/syft)
- [Grype Documentation](https://github.com/anchore/grype)
- [NIST SP 800-190 (Container Security)](https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-190.pdf)
- [Executive Order 14028 (SBOM)](https://www.whitehouse.gov/briefing-room/presidential-actions/2021/05/12/executive-order-on-improving-the-nations-cybersecurity/)
- [OWASP ASVS v4.0.3](https://owasp.org/www-project-application-security-verification-standard/)

---

## ğŸ†˜ Troubleshooting

### **"Docker image not found"**
```bash
# Pull images manually
docker pull ghcr.io/gitleaks/gitleaks:latest
docker pull aquasec/trivy:latest
docker pull anchore/syft:latest
docker pull anchore/grype:latest
```

### **"Permission denied on .runtime/sbom/"**
```bash
# Fix permissions (created by root in Docker)
sudo chown -R $USER:$USER .runtime/sbom
```

### **"Grype is too slow"**
```bash
# Skip Grype for quick checks
make scan-secrets scan-vulns sbom
```