# ğŸ—ï¸ Architecture Phase 2.1 â€” Provisioning IAM avec Audit Trail

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           CLIENT (Browser/curl)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ HTTPS (TLS 1.3)
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Reverse Proxy (nginx)                                 â”‚
â”‚  â€¢ TLS termination                                                           â”‚
â”‚  â€¢ HSTS enforcement                                                          â”‚
â”‚  â€¢ Security headers (CSP, X-Frame-Options, etc.)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ X-Forwarded-* headers
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Flask Application                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      Admin Routes (/admin)                           â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  POST /admin/joiner  â”€â”€â”                                            â”‚   â”‚
â”‚  â”‚  POST /admin/mover   â”€â”€â”¼â”€â”€> Validation Layer                        â”‚   â”‚
â”‚  â”‚  POST /admin/leaver  â”€â”€â”˜     â€¢ _normalize_username()                â”‚   â”‚
â”‚  â”‚                               â€¢ _validate_email()                     â”‚   â”‚
â”‚  â”‚                               â€¢ _validate_name()                      â”‚   â”‚
â”‚  â”‚                               â€¢ CSRF token check                      â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚                               â†“                                       â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚                          Authorization                                â”‚   â”‚
â”‚  â”‚                          @require_role(iam-operator)                 â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚                               â†“                                       â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚              JML Operations (scripts/jml.py)                  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                               â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  create_user()    â”€â”                                         â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  change_role()    â”€â”¼â”€> Keycloak Admin API                   â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  disable_user()   â”€â”˜    â€¢ Bearer token (service account)    â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                          â€¢ Idempotent operations             â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                               â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  disable_user() flow:                                        â”‚  â”‚   â”‚
â”‚  â”‚  â”‚    1. GET /users/{id}/sessions                               â”‚  â”‚   â”‚
â”‚  â”‚  â”‚    2. POST /users/{id}/logout    â† âœ¨ NEW: Session revoke   â”‚  â”‚   â”‚
â”‚  â”‚  â”‚    3. PUT /users/{id} enabled=false                          â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                               â”‚                                     â”‚   â”‚
â”‚  â”‚                               â†“ Success/Failure                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚           Audit Logger (scripts/audit.py)                    â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                               â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  log_jml_event(                                              â”‚  â”‚   â”‚
â”‚  â”‚  â”‚    event_type="joiner|mover|leaver",                        â”‚  â”‚   â”‚
â”‚  â”‚  â”‚    username="alice",                                         â”‚  â”‚   â”‚
â”‚  â”‚  â”‚    operator="joe@example.com",                              â”‚  â”‚   â”‚
â”‚  â”‚  â”‚    success=True|False,                                       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚    details={...}                                             â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  )                                                            â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                               â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  1. Build canonical JSON                                     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  2. Sign with HMAC-SHA256(key, json)                        â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  3. Append to .runtime/audit/jml-events.jsonl               â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  4. Set permissions 600 (owner read/write only)             â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  GET /admin/audit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> Display audit trail              â”‚   â”‚
â”‚  â”‚                                   â€¢ Chronological order             â”‚   â”‚
â”‚  â”‚                                   â€¢ Signature verification          â”‚   â”‚
â”‚  â”‚                                   â€¢ Filter by type/status           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Keycloak (IAM Provider)                             â”‚
â”‚                                                                              â”‚
â”‚  Realm: demo                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Users:                                                          â”‚        â”‚
â”‚  â”‚   alice  (enabled=true,  roles=[iam-operator], totp=âœ…)       â”‚        â”‚
â”‚  â”‚   bob    (enabled=false, roles=[analyst])        â† leaver      â”‚        â”‚
â”‚  â”‚   joe    (enabled=true,  roles=[realm-admin])                 â”‚        â”‚
â”‚  â”‚                                                                 â”‚        â”‚
â”‚  â”‚ Clients:                                                        â”‚        â”‚
â”‚  â”‚   flask-app       (public, OIDC)                               â”‚        â”‚
â”‚  â”‚   automation-cli  (confidential, service account)              â”‚        â”‚
â”‚  â”‚                                                                 â”‚        â”‚
â”‚  â”‚ Sessions:                                                       â”‚        â”‚
â”‚  â”‚   alice: session_xyz (last_access=2min ago)                   â”‚        â”‚
â”‚  â”‚   joe:   session_abc (last_access=5sec ago)                   â”‚        â”‚
â”‚  â”‚   bob:   [REVOKED via /logout] â† âœ¨ NEW                       â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†‘
                             â”‚ Token requests (Client Credentials)
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Service Account (automation-cli)                       â”‚
â”‚                                                                              â”‚
â”‚  Permissions:                                                                â”‚
â”‚    â€¢ manage-users  (create, update, disable)                                â”‚
â”‚    â€¢ manage-realm  (roles, required actions)                                â”‚
â”‚    â€¢ manage-clients (security-admin-console config)                         â”‚
â”‚                                                                              â”‚
â”‚  Secret rotation:                                                            â”‚
â”‚    make bootstrap-service-account                                            â”‚
â”‚      â†’ Generate new secret                                                   â”‚
â”‚      â†’ Update Key Vault                                                      â”‚
â”‚      â†’ Audit log rotation (HMAC signed)                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†‘
                             â”‚ Secrets retrieval (DefaultAzureCredential)
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Azure Key Vault (Secrets Store)                        â”‚
â”‚                                                                              â”‚
â”‚  Secrets:                                                                    â”‚
â”‚    â”œâ”€ flask-secret-key                    (Flask session encryption)        â”‚
â”‚    â”œâ”€ keycloak-service-client-secret      (automation-cli credential)       â”‚
â”‚    â”œâ”€ keycloak-admin-password             (bootstrap only)                  â”‚
â”‚    â”œâ”€ alice-temp-password                 (initial joiner)                  â”‚
â”‚    â”œâ”€ bob-temp-password                   (initial joiner)                  â”‚
â”‚    â””â”€ audit-log-signing-key               âœ¨ NEW (HMAC-SHA256)             â”‚
â”‚                                                                              â”‚
â”‚  Access:                                                                     â”‚
â”‚    â€¢ Managed Identity (flask-app container)                                 â”‚
â”‚    â€¢ Role: Key Vault Secrets User                                           â”‚
â”‚    â€¢ Audit: All access logged to Azure Monitor                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                              Data Flows
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       1. JOINER (Provision User)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User (joe@example.com)
  â”‚
  â”‚ POST /admin/joiner
  â”‚   username=alice
  â”‚   email=alice@example.com
  â”‚   role=analyst
  â†“
Flask: Validation
  â”‚ â”œâ”€ _normalize_username("alice") â†’ "alice" âœ…
  â”‚ â”œâ”€ _validate_email("alice@example.com") â†’ âœ…
  â”‚ â””â”€ _validate_name("Alice") â†’ âœ…
  â†“
Flask: Authorization
  â”‚ @require_role(iam-operator) â†’ joe has role âœ…
  â†“
JML: create_user()
  â”‚ â”œâ”€ GET /users?username=alice â†’ not exists
  â”‚ â”œâ”€ POST /users {...} â†’ user_id=uuid
  â”‚ â”œâ”€ PUT /users/{uuid}/reset-password
  â”‚ â””â”€ POST /users/{uuid}/role-mappings
  â†“
Audit: log_jml_event()
  â”‚ {
  â”‚   "event_type": "joiner",
  â”‚   "username": "alice",
  â”‚   "operator": "joe@example.com",
  â”‚   "success": true,
  â”‚   "details": {"role": "analyst", "email": "alice@example.com"},
  â”‚   "signature": "a3f5b2c8..."
  â”‚ }
  â””â”€> .runtime/audit/jml-events.jsonl (append, mode 600)

Response: "User 'alice' provisioned âœ…"


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       2. LEAVER (Disable User)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User (joe@example.com)
  â”‚
  â”‚ POST /admin/leaver
  â”‚   username=bob
  â†“
Flask: Authorization
  â”‚ @require_role(iam-operator) â†’ joe has role âœ…
  â”‚ Check: bob has iam-operator role? â†’ No âœ… (can proceed)
  â†“
JML: disable_user()
  â”‚ â”œâ”€ GET /users?username=bob â†’ user_id=uuid
  â”‚ â”œâ”€ GET /users/{uuid}/sessions â†’ [session1, session2] âœ¨ NEW
  â”‚ â”œâ”€ POST /users/{uuid}/logout â†’ 204 No Content        âœ¨ NEW
  â”‚ â”‚    â†’ All refresh_tokens revoked
  â”‚ â”‚    â†’ All access_tokens blacklisted
  â”‚ â””â”€ PUT /users/{uuid} enabled=false
  â†“
Audit: log_jml_event()
  â”‚ {
  â”‚   "event_type": "leaver",
  â”‚   "username": "bob",
  â”‚   "operator": "joe@example.com",
  â”‚   "success": true,
  â”‚   "details": {"sessions_revoked": true}
  â”‚ }
  â””â”€> .runtime/audit/jml-events.jsonl

Response: "User 'bob' disabled successfully âœ…"

Bob tries to access /admin with old token:
  â†“
  401 Unauthorized (session revoked immediately)


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       3. AUDIT VERIFICATION                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Admin
  â”‚
  â”‚ make verify-audit
  â†“
scripts/audit.py
  â”‚ â”œâ”€ Read .runtime/audit/jml-events.jsonl
  â”‚ â”œâ”€ For each line:
  â”‚ â”‚   â”œâ”€ Parse JSON
  â”‚ â”‚   â”œâ”€ Extract signature
  â”‚ â”‚   â”œâ”€ Recompute HMAC-SHA256(key, canonical_json)
  â”‚ â”‚   â””â”€ Compare signatures (constant-time)
  â”‚ â””â”€ Return (total_events, valid_signatures)
  â†“
Output:
  âœ… "Audit log: 15/15 events with valid signatures"

If tampered:
  âš ï¸ "Audit log: 14/15 events with valid signatures"


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                         Security Properties
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… Confidentiality:
   â€¢ TLS 1.3 end-to-end
   â€¢ Secrets in Key Vault (not in code/logs)
   â€¢ Session cookies HttpOnly + Secure

âœ… Integrity:
   â€¢ CSRF tokens for state-changing operations
   â€¢ Audit log HMAC-SHA256 signatures
   â€¢ Input validation prevents injection

âœ… Availability:
   â€¢ Idempotent operations (safe retries)
   â€¢ Health checks (/health)
   â€¢ Graceful error handling

âœ… Accountability:
   â€¢ All JML operations logged with operator
   â€¢ Cryptographic signatures prevent tampering
   â€¢ Non-repudiation via audit trail

âœ… Authorization:
   â€¢ RBAC enforced (iam-operator, realm-admin)
   â€¢ Service account with minimal permissions
   â€¢ Self-modification prevented (can't change own role)

âœ… Session Management:
   â€¢ Leaver revokes sessions immediately     âœ¨ NEW
   â€¢ Token refresh with expiry validation
   â€¢ Logout clears all cookies + server session
```
