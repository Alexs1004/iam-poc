openapi: 3.0.3
info:
  title: IAM PoC SCIM 2.0 API
  version: 2.0.0
  description: |
    **RFC 7644 compliant SCIM 2.0 service** for enterprise identity lifecycle management.
    
    **Key Features:**
    - Multi-operation PATCH (RFC 7644 § 3.5.2): add, replace operations
    - Complex multi-valued attributes: emails, phoneNumbers with type filters
    - UPN username format support (alice@domain.com)
    - Azure Entra ID Enterprise App compatible
    - Static Bearer Token OR OAuth2 authentication
    - Comprehensive schema discovery (/Schemas, /ResourceTypes, /ServiceProviderConfig)
    
    **Supported PATCH paths:**
    - `active` (boolean)
    - `displayName` (string)
    - `name.givenName`, `name.familyName` (string)
    - `emails[type eq "work"].value` (string, upsert semantics)
    - `emails[type eq "work"].primary` (boolean)
    - `phoneNumbers[type eq "mobile"].value` (string, upsert semantics)
    - `phoneNumbers[type eq "mobile"].primary` (boolean)
    
    **Authentication:**
    - OAuth2 Bearer Token (Keycloak service account)
    - Static Bearer Token (Azure Entra ID Enterprise App: `SCIM_STATIC_TOKEN`)
    
    **Production Deployment:** https://github.com/Alexs1004/iam-poc
  contact:
    name: Alexs1004 — IAM & Cloud Security
    url: https://github.com/Alexs1004/iam-poc
servers:
  - url: https://localhost
    description: Local HTTPS reverse proxy (demo stack)
  # - url: http://keycloak:8080
  #   description: Internal cluster access for integration tests only (not a public SCIM base URL)
security:
  - BearerAuth: []
tags:
  - name: Metadata
    description: SCIM metadata and capability discovery endpoints
  - name: Users
    description: CRUD lifecycle for SCIM Users (Joiner/Mover/Leaver)

paths:
  /scim/v2/ServiceProviderConfig:
    get:
      tags: [Metadata]
      summary: Retrieve service provider configuration
      operationId: getServiceProviderConfig
      responses:
        '200':
          description: Service provider capabilities
          content:
            application/scim+json:
              schema:
                $ref: '#/components/schemas/ServiceProviderConfig'
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }

  /scim/v2/ResourceTypes:
    get:
      tags: [Metadata]
      summary: List supported SCIM resource types
      operationId: listResourceTypes
      responses:
        '200':
          description: Available SCIM resource types
          content:
            application/scim+json:
              schema:
                $ref: '#/components/schemas/ResourceTypeList'
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }

  /scim/v2/Schemas:
    get:
      tags: [Metadata]
      summary: List supported SCIM schemas
      operationId: listSchemas
      responses:
        '200':
          description: SCIM schema list
          content:
            application/scim+json:
              schema:
                $ref: '#/components/schemas/SchemaList'
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }

  /scim/v2/Schemas/{schemaId}:
    get:
      tags: [Metadata]
      summary: Retrieve detailed schema definition
      description: |
        Returns the complete attribute metadata for a SCIM schema (RFC 7643 § 7).
        
        **Supported schemas:**
        - `urn:ietf:params:scim:schemas:core:2.0:User`
      operationId: getSchema
      parameters:
        - name: schemaId
          in: path
          required: true
          description: Schema URN identifier
          schema:
            type: string
            example: urn:ietf:params:scim:schemas:core:2.0:User
      responses:
        '200':
          description: Schema definition with attribute metadata
          content:
            application/scim+json:
              schema:
                $ref: '#/components/schemas/SchemaDefinition'
              example:
                id: urn:ietf:params:scim:schemas:core:2.0:User
                name: User
                description: User Account
                schemas: ["urn:ietf:params:scim:schemas:core:2.0:Schema"]
                attributes:
                  - name: userName
                    type: string
                    multiValued: false
                    required: true
                    caseExact: false
                    mutability: readWrite
                    returned: default
                    uniqueness: server
                  - name: emails
                    type: complex
                    multiValued: true
                    required: false
                    mutability: readWrite
                    returned: default
                    subAttributes:
                      - name: value
                        type: string
                        multiValued: false
                        required: false
                      - name: type
                        type: string
                        canonicalValues: ["work", "home", "other"]
                meta:
                  resourceType: Schema
                  location: https://localhost/scim/v2/Schemas/urn:ietf:params:scim:schemas:core:2.0:User
        '404':
          description: Schema not found
          content:
            application/scim+json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                schemas: ["urn:ietf:params:scim:api:messages:2.0:Error"]
                status: "404"
                detail: "Schema urn:unknown:schema not found"
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }

  /scim/v2/Users:
    get:
      tags: [Users]
      summary: Search or list users
      description: >
        Supports pagination and filtering by `userName`. Filtering operators are
        restricted to `eq` for security hardening.
      operationId: listUsers
      parameters:
        - $ref: '#/components/parameters/Filter'
        - $ref: '#/components/parameters/StartIndex'
        - $ref: '#/components/parameters/Count'
      responses:
        '200':
          description: List response
          content:
            application/scim+json:
              schema:
                $ref: '#/components/schemas/UserListResponse'
              example:
                schemas: ["urn:ietf:params:scim:api:messages:2.0:ListResponse"]
                totalResults: 1
                startIndex: 1
                itemsPerPage: 1
                Resources:
                  - schemas: ["urn:ietf:params:scim:schemas:core:2.0:User"]
                    id: 961af613-5f9d-4b86-a0f2-b5b7f0eac1ab
                    userName: demo.scim
                    active: true
                    name:
                      givenName: Demo
                      familyName: SCIM
                    emails:
                      - value: demo.scim@example.ch
                        type: work
                        primary: true
                    meta:
                      resourceType: User
                      location: https://localhost/scim/v2/Users/961af613-5f9d-4b86-a0f2-b5b7f0eac1ab
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '501': { $ref: '#/components/responses/NotImplemented' }
        '500': { $ref: '#/components/responses/InternalError' }

    post:
      tags: [Users]
      summary: Create a new user
      operationId: createUser
      requestBody:
        required: true
        content:
          application/scim+json:
            schema:
              $ref: '#/components/schemas/UserCreateRequest'
            example:
              schemas: ["urn:ietf:params:scim:schemas:core:2.0:User"]
              userName: demo.scim
              name:
                givenName: Demo
                familyName: SCIM
              emails:
                - value: demo.scim@example.ch
                  type: work
                  primary: true
              active: true
      responses:
        '201':
          description: Created user
          content:
            application/scim+json:
              schema:
                $ref: '#/components/schemas/User'
              example:
                schemas: ["urn:ietf:params:scim:schemas:core:2.0:User"]
                id: 961af613-5f9d-4b86-a0f2-b5b7f0eac1ab
                userName: demo.scim
                active: true
                name:
                  givenName: Demo
                  familyName: SCIM
                emails:
                  - value: demo.scim@example.ch
                    type: work
                    primary: true
                meta:
                  resourceType: User
                  location: https://localhost/scim/v2/Users/961af613-5f9d-4b86-a0f2-b5b7f0eac1ab
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '409': { $ref: '#/components/responses/Conflict' }
        '413': { $ref: '#/components/responses/PayloadTooLarge' }
        '415': { $ref: '#/components/responses/UnsupportedMediaType' }
        '500': { $ref: '#/components/responses/InternalError' }

  /scim/v2/Users/{id}:
    parameters:
      - $ref: '#/components/parameters/UserId'
    get:
      tags: [Users]
      summary: Retrieve a user by identifier
      operationId: getUser
      responses:
        '200':
          description: User representation
          content:
            application/scim+json:
              schema:
                $ref: '#/components/schemas/User'
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '404': { $ref: '#/components/responses/NotFound' }
        '500': { $ref: '#/components/responses/InternalError' }

    put:
      tags: [Users]
      summary: Full replace not supported
      description: >
        Full replace is not implemented. This endpoint always returns 501. Use PATCH
        (replace path=active) to toggle enable/disable, or DELETE for soft-delete.
      operationId: replaceUser
      requestBody:
        required: true
        content:
          application/scim+json:
            schema:
              $ref: '#/components/schemas/UserUpdateRequest'
      responses:
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '404': { $ref: '#/components/responses/NotFound' }
        '415': { $ref: '#/components/responses/UnsupportedMediaType' }
        '500': { $ref: '#/components/responses/InternalError' }
        '501': { $ref: '#/components/responses/NotImplemented' }

    patch:
      tags: [Users]
      summary: Partial update user attributes (RFC 7644 § 3.5.2)
      description: |
        **Multi-operation PATCH support** with add and replace operations.
        
        **Supported operations:**
        - `add`: Create or update attribute (upsert semantics)
        - `replace`: Update existing attribute
        
        **Supported paths:**
        - `active` (boolean): Enable/disable user account
        - `displayName` (string): Full display name (splits to firstName/lastName)
        - `name.givenName` (string): First name
        - `name.familyName` (string): Last name
        - `emails[type eq "work"].value` (string): Work email (upsert)
        - `emails[type eq "work"].primary` (boolean): Primary flag
        - `phoneNumbers[type eq "mobile"].value` (string): Mobile phone (upsert)
        - `phoneNumbers[type eq "mobile"].primary` (boolean): Primary flag
        
        **Multi-operation behavior:**
        - Multiple operations processed sequentially
        - Last operation wins for conflicting paths
        - Upsert semantics: `add` creates if missing, updates if exists
        
        **Examples:**
        ```json
        // Disable account
        {"Operations": [{"op": "replace", "path": "active", "value": false}]}
        
        // Update name
        {"Operations": [
          {"op": "replace", "path": "name.givenName", "value": "Alice"},
          {"op": "replace", "path": "name.familyName", "value": "Smith"}
        ]}
        
        // Add/update work email
        {"Operations": [
          {"op": "add", "path": "emails[type eq \"work\"].value", "value": "alice@company.com"}
        ]}
        ```
      operationId: patchUser
      requestBody:
        required: true
        content:
          application/scim+json:
            schema:
              $ref: '#/components/schemas/UserPatchRequest'
            examples:
              disableAccount:
                summary: Disable user account
                value:
                  schemas: ["urn:ietf:params:scim:api:messages:2.0:PatchOp"]
                  Operations:
                    - op: replace
                      path: active
                      value: false
              updateName:
                summary: Update user name
                value:
                  schemas: ["urn:ietf:params:scim:api:messages:2.0:PatchOp"]
                  Operations:
                    - op: replace
                      path: name.givenName
                      value: Alice
                    - op: replace
                      path: name.familyName
                      value: Smith
              addWorkEmail:
                summary: Add or update work email (upsert)
                value:
                  schemas: ["urn:ietf:params:scim:api:messages:2.0:PatchOp"]
                  Operations:
                    - op: add
                      path: emails[type eq "work"].value
                      value: alice.work@company.com
              addMobilePhone:
                summary: Add mobile phone number
                value:
                  schemas: ["urn:ietf:params:scim:api:messages:2.0:PatchOp"]
                  Operations:
                    - op: add
                      path: phoneNumbers[type eq "mobile"].value
                      value: "+33612345678"
              multiOperation:
                summary: Multiple operations (last wins)
                value:
                  schemas: ["urn:ietf:params:scim:api:messages:2.0:PatchOp"]
                  Operations:
                    - op: replace
                      path: displayName
                      value: Alice Smith
                    - op: add
                      path: emails[type eq "work"].value
                      value: alice@company.com
                    - op: replace
                      path: active
                      value: true
      responses:
        '200':
          description: Updated user representation
          content:
            application/scim+json:
              schema:
                $ref: '#/components/schemas/User'
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '404': { $ref: '#/components/responses/NotFound' }
        '413': { $ref: '#/components/responses/PayloadTooLarge' }
        '415': { $ref: '#/components/responses/UnsupportedMediaType' }
        '501': { $ref: '#/components/responses/NotImplemented' }
        '500': { $ref: '#/components/responses/InternalError' }

    delete:
      tags: [Users]
      summary: Disable (soft-delete) a user
      operationId: deleteUser
      responses:
        '204':
          description: User deactivated (no content)
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '404': { $ref: '#/components/responses/NotFound' }
        '500': { $ref: '#/components/responses/InternalError' }

  /scim/v2/Users/.search:
    post:
      tags: [Users]
      summary: Search users via POST
      description: >
        Provides compatibility with Azure AD / Okta clients that expect POST-based search.
        Accepts the same parameters as GET /Users in the request body.
      operationId: searchUsers
      requestBody:
        required: false
        content:
          application/scim+json:
            schema:
              $ref: '#/components/schemas/SearchRequest'
            example:
              schemas: ["urn:ietf:params:scim:api:messages:2.0:SearchRequest"]
              filter: userName eq "demo.scim"
              startIndex: 1
              count: 10
      responses:
        '200':
          description: List response
          content:
            application/scim+json:
              schema:
                $ref: '#/components/schemas/UserListResponse'
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '413': { $ref: '#/components/responses/PayloadTooLarge' }
        '415': { $ref: '#/components/responses/UnsupportedMediaType' }
        '501': { $ref: '#/components/responses/NotImplemented' }
        '500': { $ref: '#/components/responses/InternalError' }

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        **Two authentication methods supported:**
        
        1. **OAuth 2.0 Bearer Token** (Keycloak service account)
           - Client: `automation-cli`
           - Scopes: `scim:read`, `scim:write`
           - Issued by: Keycloak `/realms/demo/protocol/openid-connect/token`
        
        2. **Static Bearer Token** (Azure Entra ID Enterprise App)
           - Environment variable: `SCIM_STATIC_TOKEN`
           - Length: 44+ characters (cryptographically secure)
           - Used for Azure AD provisioning integration
        
        **Example:**
        ```
        Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...
        ```
        
        Requests without `Authorization` header are rejected with `401 Unauthorized`.

  parameters:
    UserId:
      name: id
      in: path
      required: true
      description: SCIM identifier (`id`) of the target user.
      schema:
        type: string
        example: 4f8c6a6e-9056-4e63-a921-2f1f9c1d7f39
    Filter:
      name: filter
      in: query
      required: false
      description: >
        RFC 7644 filter expression (currently only `userName eq "value"` is supported).
      schema:
        type: string
        example: userName eq "alice"
    StartIndex:
      name: startIndex
      in: query
      required: false
      schema:
        type: integer
        minimum: 1
        default: 1
    Count:
      name: count
      in: query
      required: false
      schema:
        type: integer
        minimum: 1
        maximum: 200
        default: 10

  responses:
    BadRequest:
      description: Malformed SCIM payload or filter expression
      content:
        application/scim+json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            schemas: ["urn:ietf:params:scim:api:messages:2.0:Error"]
            status: "400"
            detail: Content-Type must be application/scim+json.
            scimType: invalidSyntax
    Unauthorized:
      description: Missing or invalid bearer token
      content:
        application/scim+json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            schemas: ["urn:ietf:params:scim:api:messages:2.0:Error"]
            status: "401"
            detail: Authorization header missing or invalid.
            scimType: unauthorized
    Forbidden:
      description: Authenticated but not authorised to perform the operation
      content:
        application/scim+json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            schemas: ["urn:ietf:params:scim:api:messages:2.0:Error"]
            status: "403"
            detail: Insufficient scope for requested operation.
            scimType: forbidden
    NotFound:
      description: Resource not found
      content:
        application/scim+json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            schemas: ["urn:ietf:params:scim:api:messages:2.0:Error"]
            status: "404"
            detail: Requested resource not found.
            scimType: notFound
    Conflict:
      description: Resource conflict (duplicate userName)
      content:
        application/scim+json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            schemas: ["urn:ietf:params:scim:api:messages:2.0:Error"]
            status: "409"
            detail: userName already exists.
            scimType: uniqueness
    UnsupportedMediaType:
      description: Content-Type must be application/scim+json
      content:
        application/scim+json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            schemas: ["urn:ietf:params:scim:api:messages:2.0:Error"]
            status: "415"
            detail: Content-Type must be application/scim+json.
            scimType: invalidSyntax
    PayloadTooLarge:
      description: Request payload exceeds maximum allowed size (64 KB)
      content:
        application/scim+json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            schemas: ["urn:ietf:params:scim:api:messages:2.0:Error"]
            status: "413"
            detail: Request payload exceeds maximum allowed size (64 KB).
            scimType: invalidValue
    NotImplemented:
      description: Feature not implemented (e.g. unsupported SCIM filter operator)
      content:
        application/scim+json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            schemas: ["urn:ietf:params:scim:api:messages:2.0:Error"]
            status: "501"
            detail: Requested SCIM feature is not available in this PoC.
            scimType: notImplemented
    InternalError:
      description: Unexpected server error
      content:
        application/scim+json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            schemas: ["urn:ietf:params:scim:api:messages:2.0:Error"]
            status: "500"
            detail: Unexpected error while processing the request.
            scimType: internalError
  schemas:
    ServiceProviderConfig:
      type: object
      required: [schemas, documentationUri, patch, filter, bulk, changePassword, etag, sort]
      properties:
        schemas:
          type: array
          items: { type: string }
          example: ["urn:ietf:params:scim:schemas:core:2.0:ServiceProviderConfig"]
        documentationUri:
          type: string
          format: uri
          example: https://localhost/scim/docs
        patch:
          $ref: '#/components/schemas/FeatureAvailability'
        bulk:
          $ref: '#/components/schemas/BulkFeature'
        filter:
          allOf:
            - $ref: '#/components/schemas/FeatureAvailability'
            - type: object
              properties:
                maxResults:
                  type: integer
                  example: 200
        changePassword:
          $ref: '#/components/schemas/FeatureAvailability'
        sort:
          $ref: '#/components/schemas/FeatureAvailability'
        etag:
          $ref: '#/components/schemas/FeatureAvailability'
      example:
        schemas: ["urn:ietf:params:scim:schemas:core:2.0:ServiceProviderConfig"]
        documentationUri: https://localhost/scim/docs
        patch:
          supported: true
        bulk:
          supported: false
          maxOperations: 0
          maxPayloadSize: 0
        filter:
          supported: true
          maxResults: 200
        changePassword:
          supported: false
        sort:
          supported: false
        etag:
          supported: false
        authenticationSchemes:
          - name: OAuth 2.0 Bearer Token
            description: OAuth 2.0 client credentials with service account automation-cli.
            specUri: https://www.rfc-editor.org/rfc/rfc6750
            type: oauthbearertoken
            primary: true

    FeatureAvailability:
      type: object
      required: [supported]
      properties:
        supported:
          type: boolean

    BulkFeature:
      allOf:
        - $ref: '#/components/schemas/FeatureAvailability'
        - type: object
          properties:
            maxOperations:
              type: integer
              example: 0
            maxPayloadSize:
              type: integer
              example: 0

    FilterFeature:
      allOf:
        - $ref: '#/components/schemas/FeatureAvailability'
        - type: object
          properties:
            maxResults:
              type: integer
              example: 200

    ResourceTypeList:
      type: object
      required: [schemas, Resources]
      properties:
        schemas:
          type: array
          items: { type: string }
          example: ["urn:ietf:params:scim:api:messages:2.0:ListResponse"]
        Resources:
          type: array
          items:
            type: object
          description: Raw SCIM resource type representations.
        totalResults:
          type: integer
          example: 1
    SchemaList:
      type: object
      required: [schemas, totalResults, Resources]
      properties:
        schemas:
          type: array
          items: { type: string }
          example: ["urn:ietf:params:scim:api:messages:2.0:ListResponse"]
        totalResults:
          type: integer
          example: 1
        Resources:
          type: array
          items:
            type: object
          description: SCIM schema definitions (core:User, etc.).
    
    SchemaDefinition:
      type: object
      required: [id, name, schemas, attributes]
      description: RFC 7643 § 7 - Complete schema definition with attribute metadata
      properties:
        id:
          type: string
          example: urn:ietf:params:scim:schemas:core:2.0:User
        name:
          type: string
          example: User
        description:
          type: string
          example: User Account
        schemas:
          type: array
          items: { type: string }
          example: ["urn:ietf:params:scim:schemas:core:2.0:Schema"]
        attributes:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
                example: userName
              type:
                type: string
                enum: [string, boolean, integer, decimal, dateTime, reference, complex]
                example: string
              multiValued:
                type: boolean
                example: false
              required:
                type: boolean
                example: true
              caseExact:
                type: boolean
                example: false
              mutability:
                type: string
                enum: [readOnly, readWrite, immutable, writeOnly]
                example: readWrite
              returned:
                type: string
                enum: [always, never, default, request]
                example: default
              uniqueness:
                type: string
                enum: [none, server, global]
                example: server
              subAttributes:
                type: array
                description: For complex types (emails, phoneNumbers)
                items:
                  type: object
              canonicalValues:
                type: array
                description: Valid values for enumerations
                items:
                  type: string
                example: ["work", "home", "other"]
        meta:
          type: object
          properties:
            resourceType:
              type: string
              example: Schema
            location:
              type: string
              format: uri
              example: https://localhost/scim/v2/Schemas/urn:ietf:params:scim:schemas:core:2.0:User
    SearchRequest:
      type: object
      properties:
        schemas:
          type: array
          items: { type: string }
          description: MAY include urn:ietf:params:scim:api:messages:2.0:SearchRequest.
        filter:
          type: string
          description: RFC 7644 filter expression (only `userName eq \"value\"` supported).
        startIndex:
          type: integer
          minimum: 1
          default: 1
        count:
          type: integer
          minimum: 1
          maximum: 100
          default: 25

    User:
      type: object
      required: [schemas, id, userName, active]
      description: SCIM User resource (RFC 7643 § 4.1)
      properties:
        schemas:
          type: array
          items: { type: string }
          example: ["urn:ietf:params:scim:schemas:core:2.0:User"]
        id:
          type: string
          description: Unique identifier (Keycloak user UUID)
          example: 5111c028-18a2-4eb4-8b41-08bf4dcdce5a
        externalId:
          type: string
          nullable: true
          description: External system identifier (optional)
        userName:
          type: string
          description: |
            Unique username for login.
            
            **Supported formats:**
            - Alphanumeric: `alice`, `bob123`
            - UPN: `alice@example.com`, `bob@company.ch`
            - Underscores/hyphens: `alice_wonder`, `bob-smith`
          example: alice@example.com
        displayName:
          type: string
          description: Full display name (computed from firstName + lastName in Keycloak)
          example: Alice Wonder
        name:
          $ref: '#/components/schemas/Name'
        emails:
          type: array
          items:
            $ref: '#/components/schemas/Email'
          description: Multi-valued email addresses (work, home, other)
        phoneNumbers:
          type: array
          items:
            $ref: '#/components/schemas/PhoneNumber'
          description: Multi-valued phone numbers (mobile, work, home)
        active:
          type: boolean
          description: Account enabled status (true = active, false = disabled)
          example: true
        meta:
          $ref: '#/components/schemas/Meta'

    UserCreateRequest:
      allOf:
        - $ref: '#/components/schemas/UserUpdateRequest'
      required: [userName, emails]

    UserUpdateRequest:
      type: object
      required: [schemas]
      description: User update payload (PUT /Users/{id} - currently returns 501)
      properties:
        schemas:
          type: array
          items: { type: string }
          default: ["urn:ietf:params:scim:schemas:core:2.0:User"]
        userName:
          type: string
          description: Username (UPN format supported)
          example: alice@example.com
        displayName:
          type: string
          description: Full display name
          example: Alice Wonder
        name:
          $ref: '#/components/schemas/Name'
        emails:
          type: array
          items:
            $ref: '#/components/schemas/Email'
        phoneNumbers:
          type: array
          items:
            $ref: '#/components/schemas/PhoneNumber'
        active:
          type: boolean
          description: Account enabled status
          example: true

    UserPatchRequest:
      type: object
      required: [schemas, Operations]
      description: |
        RFC 7644 § 3.5.2 compliant PATCH request with multi-operation support.
        
        **Supported operations:** `add`, `replace`
        
        **Supported paths:** See endpoint description for complete list.
      properties:
        schemas:
          type: array
          minItems: 1
          maxItems: 1
          items:
            type: string
            enum: ["urn:ietf:params:scim:api:messages:2.0:PatchOp"]
        Operations:
          type: array
          minItems: 1
          description: One or more PATCH operations (processed sequentially, last wins)
          items:
            type: object
            required: [op]
            properties:
              op:
                type: string
                enum: [add, replace]
                description: |
                  - `add`: Create or update (upsert semantics)
                  - `replace`: Update existing value
              path:
                type: string
                description: |
                  Attribute path (optional for single-value operations).
                  
                  **Examples:**
                  - `active`
                  - `displayName`
                  - `name.givenName`
                  - `name.familyName`
                  - `emails[type eq "work"].value`
                  - `emails[type eq "work"].primary`
                  - `phoneNumbers[type eq "mobile"].value`
                  - `phoneNumbers[type eq "mobile"].primary`
                example: active
              value:
                oneOf:
                  - type: boolean
                  - type: string
                  - type: object
                  - type: array
                description: New value for the attribute
                example: false

    UserListResponse:
      type: object
      required: [schemas, totalResults, startIndex, itemsPerPage, Resources]
      properties:
        schemas:
          type: array
          items: { type: string }
          example: ["urn:ietf:params:scim:api:messages:2.0:ListResponse"]
        totalResults:
          type: integer
          example: 1
        startIndex:
          type: integer
          example: 1
        itemsPerPage:
          type: integer
          example: 1
        Resources:
          type: array
          items:
            $ref: '#/components/schemas/User'

    Name:
      type: object
      properties:
        givenName: { type: string }
        familyName: { type: string }

    Email:
      type: object
      required: [value]
      properties:
        value:
          type: string
          format: email
          example: alice@example.com
        type:
          type: string
          enum: [work, home, other]
          example: work
        primary:
          type: boolean
          example: true

    PhoneNumber:
      type: object
      required: [value]
      description: Multi-valued phone number attribute (RFC 7643 § 4.1.2)
      properties:
        value:
          type: string
          description: Phone number in E.164 format recommended
          example: "+33612345678"
        type:
          type: string
          enum: [work, home, mobile, fax, pager, other]
          example: mobile
        primary:
          type: boolean
          example: true

    Meta:
      type: object
      properties:
        resourceType:
          type: string
          example: User
        created:
          type: string
          format: date-time
        lastModified:
          type: string
          format: date-time
        location:
          type: string
          format: uri

    Error:
      type: object
      required: [schemas, detail, status]
      properties:
        schemas:
          type: array
          items: { type: string }
        status:
          type: string
        detail:
          type: string
        scimType:
          type: string
          nullable: true
