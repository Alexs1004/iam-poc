FROM hashicorp/terraform:1.9-alpine

RUN apk add --no-cache \
    bash \
    curl \
    ca-certificates \
    && rm -rf /var/cache/apk/*

RUN curl -sL https://aka.ms/InstallAzureCLIDeb | bash

WORKDIR /workspace

COPY --chmod=755 <<'EOF' /usr/local/bin/terraform-wrapper
#!/bin/bash
if [ -f /run/secrets/arm_client_secret ]; then
    export ARM_CLIENT_SECRET=$(cat /run/secrets/arm_client_secret)
fi
exec terraform "$@"
EOF

ENTRYPOINT ["terraform-wrapper"]
